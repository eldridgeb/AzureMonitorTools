# Azure Log Analytics Usage 
---
## Overview
This script collects information regarding the usage of all Azure Log Analytics workspaces (LAWs) across an Azure environment / tenant.

It is designed to be run in large Azure environments, were multiple Log Analytics workspaces are deployed and their usage may not be well understood. 

The script generates data in a number of output files, which can be used to plan and implement activities such as Log Analytics standardisation and workspace consolidation. 

---
## Pre-requisites

### PowerShell and Azure CLI
This script has been tested with 
* PowerShell Core version `7.3.3` 
* Azure CLI version `2.46.0`
* Windows 11

For installation instructions, please visit:
* https://learn.microsoft.com/en-us/powershell/scripting/install/installing-powershell?view=powershell-7.3
* https://learn.microsoft.com/en-us/cli/azure/install-azure-cli


### Azure access
Running this script requires the `Reader` role for all in-scope Azure Subscriptions / LAWs

---
## Instructions

Running the script with no parameters will gather usage data for LAWs in the user's default Azure tenant / directory:

`.\AzureLogAnalyticsUsage.ps1`

To specify a different tenant, use the **-TenantId** parameter:

`.\AzureLogAnalyticsUsage.ps1 -TenantId xxxx-xxxx-xxxx-xxxx`


---
## Output

The script produces the following four output files:

| File Name | Description |
| ----------- | ----------- |
| AzureLogAnalytics-WorkspaceUsage.csv | Summary of all LAWs across all subscriptions. Also lists the tables (DataTypes) in each LAW and how much data has been in each table over the last 30 days |
| AzureLogAnalytics-MappedTables.csv | Lists the individual resources that have written data to each table over the last 30 days. Note that while this covers most common Log Analytics tables with a standard schema, not all tables are covered. This helps identify where logging settings may be configured on individual resources, and can help plan consolidation work. Additional tables may be added in future revisions of this script. |
| AzureLogAnalytics-UnusedWorkspaces.csv | Lists all LAWs that have had no logs ingested over the last 30 days. These may be considered for deletion. |
| AzureLogAnalytics-UnmappedTables.csv | Lists tables that were not included in the **AzureLogAnalytics-MappedTables.csv** file above, due to the table schema not being included in this script. This may be because the table is not particularly common, or is not used by multiple individual resources with their own loggging settings. |


Addtionally, the script writes a log file to the following location to assist with troubleshooting:

`.\AzureLogAnalyticsUsage-yyyy-MM-dd-HHmm.log`

---

## To Do
*Create a Power BI report template to simplify visualisation and analysis of the data generated by this script...*